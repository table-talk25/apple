"use strict";(self.webpackChunktable_talk_client=self.webpackChunktable_talk_client||[]).push([[459],{4459:(a,e,t)=>{t.r(e),t.d(e,{default:()=>S});var c=t(5043),n=t(3216),i=t(1282),l=t.n(i),o=t(7417),s=t(3519),r=t(1719),d=t(4282),u=t(184),_=t(7102);const p=async a=>(await _.default.get("/video/token/".concat(a))).data,k={getToken:p,getTwilioToken:async a=>p(a),endCall:async a=>(await _.default.post("/video/meals/".concat(a,"/end"))).data},m="VideoCallPage_videoPage__FdnF1",f="VideoCallPage_videoGrid__OdeRP",h="VideoCallPage_localVideoContainer__1zyit",C="VideoCallPage_participantCard__V2lIL",b="VideoCallPage_localVideo__zSJkb",v="VideoCallPage_participantVideo__Rp7Wv",g="VideoCallPage_localLabel__IbMgr",j="VideoCallPage_participantName__FuOeH",x="VideoCallPage_controlsBar__Ha3Bl",P="VideoCallPage_controlBtn__2+wbp",V="VideoCallPage_disconnectBtn__Sxb9g",y="VideoCallPage_btnOff__tHhNr";t(3401);var N=t(579);const S=()=>{const{mealId:a}=(0,n.g)(),e=(0,n.Zp)(),[t,i]=(0,c.useState)(null),[_,p]=(0,c.useState)([]),[S,w]=(0,c.useState)(!0),[T,E]=(0,c.useState)(""),[R,I]=(0,c.useState)(!0),[A,z]=(0,c.useState)(!0),B=(0,c.useRef)();(0,c.useRef)();(0,c.useEffect)(()=>{let e=null;return(async()=>{try{w(!0),console.log("\ud83c\udfa5 [VideoCall] Richiesta token per pasto:",a);const{token:t,roomName:c}=await k.getToken(a);console.log("\ud83c\udfa5 [VideoCall] Connessione alla stanza Twilio:",c),e=await l().connect(t,{name:c,audio:!0,video:{width:640}}),i(e),w(!1),console.log("\u2705 [VideoCall] Connesso alla stanza:",e.name);const n=Array.from(e.localParticipant.videoTracks.values())[0];n&&B.current&&n.track.attach(B.current);const o=Array.from(e.participants.values());p(o),e.on("participantConnected",a=>{console.log("\ud83d\udc64 [VideoCall] Partecipante entrato:",a.identity),p(e=>[...e,a])}),e.on("participantDisconnected",a=>{console.log("\ud83d\udc4b [VideoCall] Partecipante uscito:",a.identity),p(e=>e.filter(e=>e!==a))}),e.on("disconnected",()=>{O()})}catch(t){console.error("\u274c [VideoCall] Errore connessione:",t),E("Impossibile accedere alla videochiamata. Verifica i permessi o riprova."),w(!1)}})(),()=>{e&&(e.disconnect(),e.localParticipant.tracks.forEach(a=>{a.track.stop();a.track.detach().forEach(a=>a.remove())}))}},[a]);const H=a=>{let{participant:e}=a;const t=(0,c.useRef)(),n=(0,c.useRef)();return(0,c.useEffect)(()=>{const a=a=>{"video"===a.kind&&t.current&&a.attach(t.current),"audio"===a.kind&&n.current&&a.attach(n.current)},c=a=>{a.detach()};return e.on("trackSubscribed",a),e.on("trackUnsubscribed",c),e.tracks.forEach(e=>{e.isSubscribed&&a(e.track)}),()=>{e.off("trackSubscribed",a),e.off("trackUnsubscribed",c)}},[e]),(0,N.jsxs)("div",{className:C,children:[(0,N.jsx)("video",{ref:t,autoPlay:!0,playsInline:!0,className:v}),(0,N.jsx)("audio",{ref:n,autoPlay:!0,muted:!1}),(0,N.jsx)("div",{className:j,children:e.identity})]})},O=()=>{t&&t.disconnect(),e("/meals/".concat(a))};return S?(0,N.jsx)("div",{className:"d-flex justify-content-center align-items-center vh-100",children:(0,N.jsx)(o.A,{animation:"border"})}):T?(0,N.jsxs)(s.A,{className:"mt-5",children:[(0,N.jsx)(r.A,{variant:"danger",children:T}),(0,N.jsx)(d.A,{onClick:()=>e(-1),children:"Torna Indietro"})]}):(0,N.jsxs)("div",{className:m,children:[(0,N.jsxs)("div",{className:f,children:[(0,N.jsxs)("div",{className:h,children:[(0,N.jsx)("video",{ref:B,autoPlay:!0,muted:!0,playsInline:!0,className:b}),(0,N.jsxs)("div",{className:g,children:["Tu ",R?"":"(Muted)"]})]}),_.map(a=>(0,N.jsx)(H,{participant:a},a.sid))]}),(0,N.jsxs)("div",{className:x,children:[(0,N.jsx)("button",{className:"".concat(P," ").concat(R?"":y),onClick:()=>{t&&(t.localParticipant.audioTracks.forEach(a=>{a.track.enable(!R)}),I(!R))},children:R?(0,N.jsx)(u.i0t,{}):(0,N.jsx)(u.$j$,{})}),(0,N.jsx)("button",{className:V,onClick:O,children:(0,N.jsx)(u.LRC,{})}),(0,N.jsx)("button",{className:"".concat(P," ").concat(A?"":y),onClick:()=>{t&&(t.localParticipant.videoTracks.forEach(a=>{A?a.track.disable():a.track.enable()}),z(!A))},children:A?(0,N.jsx)(u.HiP,{}):(0,N.jsx)(u._OX,{})})]})]})}}}]);
//# sourceMappingURL=459.22795d63.chunk.js.map