{"version":3,"file":"static/js/459.22795d63.chunk.js","mappings":"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","sources":["services/videoService.js","webpack://table-talk-client/./src/pages/VideoCallPage/VideoCallPage.module.css?af18","pages/VideoCallPage/index.js"],"sourcesContent":["// File: FRONTEND/client/src/services/videoService.js (Corretto)\n\nimport apiClient from './apiService'; // <-- USA L'API CLIENT UNIFICATO\n\nconst getToken = async (mealId) => {\n  const response = await apiClient.get(`/video/token/${mealId}`);\n  return response.data;\n};\n\n// Manteniamo getTwilioToken per retrocompatibilitÃ \nconst getTwilioToken = async (mealId) => {\n  return getToken(mealId);\n};\n\n// Funzione per permettere all'host di terminare la chiamata per tutti\nconst endCall = async (mealId) => {\n  const response = await apiClient.post(`/video/meals/${mealId}/end`);\n  return response.data;\n};\n\nconst videoService = {\n  getToken,\n  getTwilioToken, // Mantenuto per retrocompatibilitÃ \n  endCall,\n};\n\nexport default videoService;","// extracted by mini-css-extract-plugin\nexport default {\"videoPage\":\"VideoCallPage_videoPage__FdnF1\",\"videoGrid\":\"VideoCallPage_videoGrid__OdeRP\",\"localVideoContainer\":\"VideoCallPage_localVideoContainer__1zyit\",\"participantCard\":\"VideoCallPage_participantCard__V2lIL\",\"localVideo\":\"VideoCallPage_localVideo__zSJkb\",\"participantVideo\":\"VideoCallPage_participantVideo__Rp7Wv\",\"localLabel\":\"VideoCallPage_localLabel__IbMgr\",\"participantName\":\"VideoCallPage_participantName__FuOeH\",\"controlsBar\":\"VideoCallPage_controlsBar__Ha3Bl\",\"controlBtn\":\"VideoCallPage_controlBtn__2+wbp\",\"disconnectBtn\":\"VideoCallPage_disconnectBtn__Sxb9g\",\"btnOff\":\"VideoCallPage_btnOff__tHhNr\"};","import React, { useState, useEffect, useRef } from 'react';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport Video from 'twilio-video';\nimport { Button, Container, Spinner, Alert } from 'react-bootstrap';\nimport { FaMicrophone, FaMicrophoneSlash, FaVideo, FaVideoSlash, FaPhoneSlash } from 'react-icons/fa';\nimport videoService from '../../services/videoService';\nimport styles from './VideoCallPage.module.css'; // Assicurati di avere un CSS base o usa stili inline per test\nimport { toast } from 'react-toastify';\n\nconst VideoCallPage = () => {\n  const { mealId } = useParams();\n  const navigate = useNavigate();\n  \n  const [room, setRoom] = useState(null);\n  const [participants, setParticipants] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState('');\n  \n  const [isAudioEnabled, setIsAudioEnabled] = useState(true);\n  const [isVideoEnabled, setIsVideoEnabled] = useState(true);\n\n  // Refs per i container video (Evita re-render inutili)\n  const localVideoRef = useRef();\n  const remoteParticipantsRef = useRef();\n\n  useEffect(() => {\n    let currentRoom = null;\n\n    const startVideoCall = async () => {\n      try {\n        setLoading(true);\n        console.log('ðŸŽ¥ [VideoCall] Richiesta token per pasto:', mealId);\n        \n        const { token, roomName } = await videoService.getToken(mealId);\n        \n        console.log('ðŸŽ¥ [VideoCall] Connessione alla stanza Twilio:', roomName);\n        \n        // Connessione a Twilio\n        currentRoom = await Video.connect(token, {\n          name: roomName,\n          audio: true,\n          video: { width: 640 } // Risparmia banda\n        });\n\n        setRoom(currentRoom);\n        setLoading(false);\n        console.log('âœ… [VideoCall] Connesso alla stanza:', currentRoom.name);\n\n        // --- GESTIONE TRACCIA LOCALE ---\n        const localPub = Array.from(currentRoom.localParticipant.videoTracks.values())[0];\n        if (localPub && localVideoRef.current) {\n           localPub.track.attach(localVideoRef.current);\n        }\n\n        // --- GESTIONE PARTECIPANTI ESISTENTI ---\n        const existingParticipants = Array.from(currentRoom.participants.values());\n        setParticipants(existingParticipants);\n\n        // --- EVENT LISTENERS ---\n        \n        // Qualcuno si unisce\n        currentRoom.on('participantConnected', (participant) => {\n          console.log('ðŸ‘¤ [VideoCall] Partecipante entrato:', participant.identity);\n          setParticipants(prev => [...prev, participant]);\n        });\n\n        // Qualcuno esce\n        currentRoom.on('participantDisconnected', (participant) => {\n          console.log('ðŸ‘‹ [VideoCall] Partecipante uscito:', participant.identity);\n          setParticipants(prev => prev.filter(p => p !== participant));\n        });\n        \n        // Gestione disconnessione locale (se cade la linea)\n        currentRoom.on('disconnected', () => {\n           handleDisconnect();\n        });\n\n      } catch (err) {\n        console.error('âŒ [VideoCall] Errore connessione:', err);\n        setError('Impossibile accedere alla videochiamata. Verifica i permessi o riprova.');\n        setLoading(false);\n      }\n    };\n\n    startVideoCall();\n\n    // Cleanup on unmount (CRUCIALE)\n    return () => {\n      if (currentRoom) {\n        currentRoom.disconnect();\n        currentRoom.localParticipant.tracks.forEach(publication => {\n            publication.track.stop(); // Spegni la lucina della cam\n            const attachedElements = publication.track.detach();\n            attachedElements.forEach(element => element.remove());\n        });\n      }\n    };\n  }, [mealId]);\n\n  // Funzione per renderizzare il video remoto di un partecipante\n  const Participant = ({ participant }) => {\n    const videoRef = useRef();\n    const audioRef = useRef();\n\n    useEffect(() => {\n      const trackSubscribed = (track) => {\n        if (track.kind === 'video' && videoRef.current) track.attach(videoRef.current);\n        if (track.kind === 'audio' && audioRef.current) track.attach(audioRef.current);\n      };\n\n      const trackUnsubscribed = (track) => {\n        track.detach();\n      };\n\n      participant.on('trackSubscribed', trackSubscribed);\n      participant.on('trackUnsubscribed', trackUnsubscribed);\n\n      participant.tracks.forEach(publication => {\n        if (publication.isSubscribed) {\n          trackSubscribed(publication.track);\n        }\n      });\n\n      return () => {\n        participant.off('trackSubscribed', trackSubscribed);\n        participant.off('trackUnsubscribed', trackUnsubscribed);\n      };\n    }, [participant]);\n\n    return (\n      <div className={styles.participantCard}>\n        <video ref={videoRef} autoPlay playsInline className={styles.participantVideo} />\n        <audio ref={audioRef} autoPlay muted={false} />\n        <div className={styles.participantName}>{participant.identity}</div>\n      </div>\n    );\n  };\n\n  const handleDisconnect = () => {\n    if (room) {\n      room.disconnect();\n    }\n    navigate(`/meals/${mealId}`); // Torna al dettaglio pasto\n  };\n\n  const toggleAudio = () => {\n    if (room) {\n      room.localParticipant.audioTracks.forEach(pub => {\n        pub.track.enable(!isAudioEnabled);\n      });\n      setIsAudioEnabled(!isAudioEnabled);\n    }\n  };\n\n  const toggleVideo = () => {\n    if (room) {\n      room.localParticipant.videoTracks.forEach(pub => {\n        if (isVideoEnabled) {\n            pub.track.disable(); // Non stop(), solo disable per poter riattivare\n        } else {\n            pub.track.enable();\n        }\n      });\n      setIsVideoEnabled(!isVideoEnabled);\n    }\n  };\n\n  if (loading) return <div className=\"d-flex justify-content-center align-items-center vh-100\"><Spinner animation=\"border\" /></div>;\n  if (error) return <Container className=\"mt-5\"><Alert variant=\"danger\">{error}</Alert><Button onClick={() => navigate(-1)}>Torna Indietro</Button></Container>;\n\n  return (\n    <div className={styles.videoPage}>\n      {/* Griglia Video */}\n      <div className={styles.videoGrid}>\n        {/* Utente Locale */}\n        <div className={styles.localVideoContainer}>\n             <video ref={localVideoRef} autoPlay muted playsInline className={styles.localVideo} />\n             <div className={styles.localLabel}>Tu {isAudioEnabled ? '' : '(Muted)'}</div>\n        </div>\n        \n        {/* Partecipanti Remoti */}\n        {participants.map(participant => (\n          <Participant key={participant.sid} participant={participant} />\n        ))}\n      </div>\n\n      {/* Barra Controlli */}\n      <div className={styles.controlsBar}>\n        <button className={`${styles.controlBtn} ${!isAudioEnabled ? styles.btnOff : ''}`} onClick={toggleAudio}>\n            {isAudioEnabled ? <FaMicrophone /> : <FaMicrophoneSlash />}\n        </button>\n        \n        <button className={styles.disconnectBtn} onClick={handleDisconnect}>\n            <FaPhoneSlash />\n        </button>\n        \n        <button className={`${styles.controlBtn} ${!isVideoEnabled ? styles.btnOff : ''}`} onClick={toggleVideo}>\n            {isVideoEnabled ? <FaVideo /> : <FaVideoSlash />}\n        </button>\n      </div>\n    </div>\n  );\n};\n\nexport default VideoCallPage;\n"],"names":["getToken","async","apiClient","get","concat","mealId","data","getTwilioToken","endCall","post","VideoCallPage","useParams","navigate","useNavigate","room","setRoom","useState","participants","setParticipants","loading","setLoading","error","setError","isAudioEnabled","setIsAudioEnabled","isVideoEnabled","setIsVideoEnabled","localVideoRef","useRef","useEffect","currentRoom","console","log","token","roomName","videoService","Video","name","audio","video","width","localPub","Array","from","localParticipant","videoTracks","values","current","track","attach","existingParticipants","on","participant","identity","prev","filter","p","handleDisconnect","err","startVideoCall","disconnect","tracks","forEach","publication","stop","detach","element","remove","Participant","_ref","videoRef","audioRef","trackSubscribed","kind","trackUnsubscribed","isSubscribed","off","_jsxs","className","styles","children","_jsx","ref","autoPlay","playsInline","muted","Spinner","animation","Container","Alert","variant","Button","onClick","map","sid","toggleAudio","audioTracks","pub","enable","FaMicrophone","FaMicrophoneSlash","FaPhoneSlash","toggleVideo","disable","FaVideo","FaVideoSlash"],"ignoreList":[],"sourceRoot":""}